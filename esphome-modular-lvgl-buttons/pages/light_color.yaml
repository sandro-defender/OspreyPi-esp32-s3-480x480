---
globals:
  - id: ${widget_name}_current_hue
    type: float
    initial_value: '0.0'

  - id: ${widget_name}_current_saturation
    type: float
    initial_value: '0.0'

  - id: ${widget_name}_current_brightness
    type: int
    initial_value: '100'

  - id: ${widget_name}_current_color_temp
    type: float
    initial_value: '3000.0'

  - id: ${widget_name}_is_temp_mode
    type: bool
    initial_value: 'false'

  # New global variables to store supported modes
  - id: ${widget_name}_supports_color_temp
    type: bool
    initial_value: 'false'

  - id: ${widget_name}_supports_hs
    type: bool
    initial_value: 'false'

  - id: ${widget_name}_supports_rgb
    type: bool
    initial_value: 'false'

  - id: ${widget_name}_supports_brightness
    type: bool
    initial_value: 'false'

  # Global to store calculated color for thread-safe update
  - id: ${widget_name}_calc_color
    type: int
    initial_value: '0'

binary_sensor:
  # Track light state (on/off)
  - platform: homeassistant
    id: ${widget_name}_light_state
    entity_id: "${light_entity}"
    on_state:
  # On light state change, update the widget color
      - script.execute: ${widget_name}_update_lightbulb_color

  # Light button control
  - platform: lvgl
    id: ${widget_name}_light_btn_control
    widget: ${widget_name}_lightbulb_btn
    on_click:
  # SHORT press (50-500ms) - ALWAYS toggles the light
      - min_length: 50ms
        max_length: 500ms
        then:
          - homeassistant.action:
              action: light.toggle
              data:
                entity_id: "${light_entity}"
          - lambda: |-
              ESP_LOGD("light_btn", "Short press - toggling light");
      
  # LONG press (800-3000ms) - switch mode (only if supported)
      - min_length: 800ms
        max_length: 3000ms
        then:
          - if:
              condition:
                lambda: |-
                  // Switch mode only if the light supports BOTH modes
                  return id(${widget_name}_supports_color_temp) && 
                         (id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb));
              then:
                - lambda: |-
                    id(${widget_name}_is_temp_mode) = !id(${widget_name}_is_temp_mode);
                    ESP_LOGD("light_btn", "Long press - switching mode to: %s", 
                      id(${widget_name}_is_temp_mode) ? "ColorTemp" : "HS");
                - script.execute: ${widget_name}_toggle_gradient
              else:
                - lambda: |-
                    ESP_LOGD("light_btn", "Long press ignored - only one color mode supported");

sensor:
  # Brightness sensor
  - id: ${widget_name}_light_rgb_sensor_brightness
    platform: template
    internal: true
    lambda: |-
      if (id(${widget_name}_brightness_raw).state == "None" || id(${widget_name}_brightness_raw).state == "") {
        return 0.0f;
      }
      auto val = parse_number<float>(id(${widget_name}_brightness_raw).state);
      if (val.has_value()) {
        return val.value();
      }
      return 0.0f;
    on_value:
      - if:
          condition:
            lambda: 'return !std::isnan(x);'
          then:
            - globals.set:
                id: ${widget_name}_current_brightness
                value: !lambda return x;
            - lvgl.slider.update:
                id: ${widget_name}_light_brightness_slider
                value: !lambda return int(x);
            - script.execute: ${widget_name}_update_lightbulb_color

  # Color temp sensor
  - id: ${widget_name}_light_sensor_color_temp
    platform: template
    internal: true
    lambda: |-
      if (id(${widget_name}_color_temp_raw).state == "None" || id(${widget_name}_color_temp_raw).state == "") {
        return 2700.0f; // Default warm white
      }
      auto val = parse_number<float>(id(${widget_name}_color_temp_raw).state);
      if (val.has_value()) {
        return val.value();
      }
      return 2700.0f;
    on_value:
      - if:
          condition:
            lambda: 'return !std::isnan(x);'
          then:
            - globals.set:
                id: ${widget_name}_current_color_temp
                value: !lambda return x;
            - lvgl.arc.update:
                id: ${widget_name}_light_arc_color_temp
                value: !lambda return int(x);
            # Update the light color when temperature changes from HA
            # But only if we're in color_temp mode
            - if:
                condition:
                  lambda: 'return id(${widget_name}_is_temp_mode);'
                then:
                  - script.execute: ${widget_name}_update_lightbulb_color

text_sensor:
  # Raw Brightness sensor (to handle None)
  - platform: homeassistant
    id: ${widget_name}_brightness_raw
    entity_id: "${light_entity}"
    attribute: brightness
    internal: true
    on_value:
      then:
        - component.update: ${widget_name}_light_rgb_sensor_brightness

  # Raw Color Temp sensor (to handle None)
  - platform: homeassistant
    id: ${widget_name}_color_temp_raw
    entity_id: "${light_entity}"
    attribute: color_temp_kelvin
    internal: true
    on_value:
      then:
        - component.update: ${widget_name}_light_sensor_color_temp

  # HS Color sensor
  - platform: homeassistant
    id: ${widget_name}_light_sensor_hs
    entity_id: "${light_entity}"
    attribute: hs_color
    on_value:
      - if:
          condition:
            lambda: "return x != \"None\" && !x.empty();"
          then:
            - lambda: |-
                std::string s = x;
                size_t start = s.find('(') + 1;
                size_t comma = s.find(',');
                size_t end = s.find(')');
                float hue = 0.0f, sat = 0.0f;
                if (start < comma && comma < end) {
                  hue = atof(s.substr(start, comma - start).c_str());
                  sat = atof(s.substr(comma + 1, end - comma - 1).c_str());
                }
                id(${widget_name}_current_hue) = hue;
                id(${widget_name}_current_saturation) = sat;
            - lvgl.arc.update:
                id: ${widget_name}_light_arc_hue
                value: !lambda return id(${widget_name}_current_hue);
            # Update saturation slider only if it is visible
            - if:
                condition:
                  lambda: |-
                    return !id(${widget_name}_is_temp_mode) && 
                           (id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb));
                then:
                  - lvgl.slider.update:
                      id: ${widget_name}_light_saturation_slider
                      value: !lambda return id(${widget_name}_current_saturation);
            
            # Update the light color when HS changes from HA
            # But only if we're in HS mode
            - if:
                condition:
                  lambda: 'return !id(${widget_name}_is_temp_mode);'
                then:
                  - script.execute: ${widget_name}_update_lightbulb_color

  # Determine supported color modes
  # This sensor reads the supported_color_modes attribute and determines the light's capabilities
  - platform: homeassistant
    id: ${widget_name}_light_supported_modes
    entity_id: "${light_entity}"
    attribute: supported_color_modes
    on_value:
      - lambda: |-
          // Parse the string with supported modes
          std::string modes = x;
          
          // Check presence of each mode
          id(${widget_name}_supports_color_temp) = (modes.find("color_temp") != std::string::npos);
          id(${widget_name}_supports_hs) = (modes.find("hs") != std::string::npos);
          id(${widget_name}_supports_rgb) = (modes.find("rgb") != std::string::npos);
          
          id(${widget_name}_supports_brightness) = (
            modes.find("brightness") != std::string::npos ||
            id(${widget_name}_supports_hs) ||
            id(${widget_name}_supports_rgb) ||
            id(${widget_name}_supports_color_temp)
          );
          
          ESP_LOGD("light_widget", "═════════════════════════════════════════════════");
          ESP_LOGD("light_widget", "Supported modes: %s", modes.c_str());
          ESP_LOGD("light_widget", "Color temp: %d, HS: %d, RGB: %d, Brightness: %d",
            id(${widget_name}_supports_color_temp),
            id(${widget_name}_supports_hs),
            id(${widget_name}_supports_rgb),
            id(${widget_name}_supports_brightness)
          );
          
          // Smart selection of the initial mode
          
          if (id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb)) {
            // If HS/RGB is supported - start with it (more versatile)
            id(${widget_name}_is_temp_mode) = false;
            ESP_LOGD("light_widget", "→ Initial mode: HS (preferred for color lights)");
          } else if (id(${widget_name}_supports_color_temp)) {
            // If only ColorTemp is supported - use that
            id(${widget_name}_is_temp_mode) = true;
            ESP_LOGD("light_widget", "→ Initial mode: ColorTemp (only option)");
          } else {
            // If nothing is supported - default
            id(${widget_name}_is_temp_mode) = false;
            ESP_LOGD("light_widget", "→ Initial mode: N/A (no color modes)");
          }
          
          ESP_LOGD("light_widget", "═════════════════════════════════════════════════");
      - script.execute: ${widget_name}_update_widget_visibility

  - platform: homeassistant
    id: ${widget_name}_light_name
    entity_id: "${light_entity}"
    attribute: friendly_name
    on_value: 
      then:
        - lvgl.label.update:
            id: ${widget_name}_light_name_label
            text: !lambda return x;

lvgl:

  gradients:
    - id: ${widget_name}_hue_gradient
      direction: ver
      dither: none
      stops:
        - color: 0xFF0000
          position: 0
        - color: 0xFF00FF
          position: 42
        - color: 0x0000FF
          position: 84
        - color: 0x00FFFF
          position: 127
        - color: 0x00FF00
          position: 169
        - color: 0xFFFF00
          position: 212
        - color: 0xFF0000
          position: 255

    - id: ${widget_name}_color_temp_gradient
      direction: ver
      dither: none
      stops:
        - color: 0xA0C8FF
          position: 0
        - color: 0xE0F7FF
          position: 80
        - color: 0xFFFFFF
          position: 128
        - color: 0xFFFFE0
          position: 175
        - color: 0xFFD6A0
          position: 255

  pages:
    - id: ${widget_name}_light_page
      bg_color: slate_blue_gray
      widgets:
        # BRIGHTNESS SLIDER
        - obj:
            id: ${widget_name}_light_brightness_background
            x: -160
            y: 0
            radius: 20
            width: 80
            height: 260
            align: center
            bg_color: slate_blue_gray
            pad_all: 0
            border_opa: transp
            border_width: 0
            shadow_color: black
            shadow_spread: 2
            shadow_width: 8
            widgets:
              - slider:
                  id: ${widget_name}_light_brightness_slider
                  radius: 16
                  width: 60
                  height: 240
                  align: center
                  bg_color: steel_blue
                  shadow_color: black
                  shadow_spread: 4
                  shadow_width: 6
                  shadow_opa: transp
                  min_value: 2
                  max_value: 255
                  indicator:
                    bg_color: deep_orange
                    radius: 10
                  knob:
                    bg_opa: transp
                  
                  # on_value to update the light color in real time
                  on_value:
                    - globals.set:
                        id: ${widget_name}_current_brightness
                        value: !lambda return int(x);
                    - script.execute: ${widget_name}_update_lightbulb_color
                  
                  on_release:
                    - homeassistant.action:
                        action: light.turn_on
                        data:
                          entity_id: "${light_entity}"
                          brightness: !lambda return int(x);

        # SATURATION SLIDER
        - obj:
            id: ${widget_name}_light_saturation_background
            x: -60
            y: 0
            radius: 20
            width: 80
            height: 260
            align: center
            bg_color: slate_blue_gray
            pad_all: 0
            border_opa: transp
            border_width: 0
            shadow_color: black
            shadow_spread: 2
            shadow_width: 8
            widgets:
              - slider:
                  id: ${widget_name}_light_saturation_slider
                  radius: 16
                  width: 60
                  height: 240
                  align: center
                  bg_color: steel_blue
                  shadow_color: black
                  shadow_spread: 4
                  shadow_width: 6
                  shadow_opa: transp
                  min_value: 0
                  max_value: 100
                  indicator:
                    bg_color: red
                    radius: 10
                  knob:
                    bg_opa: transp
                  
                  # on_value to update the light color in real time
                  on_value:
                    - globals.set:
                        id: ${widget_name}_current_saturation
                        value: !lambda return x;
                    - script.execute: ${widget_name}_update_lightbulb_color
                  
                  on_release:
                    - homeassistant.action:
                        action: light.turn_on
                        data:
                          entity_id: "${light_entity}"
                        data_template:
                          hs_color: "{{ (hue|float, sat|float)|list }}"
                        variables:
                          hue: !lambda return id(${widget_name}_current_hue);
                          sat: !lambda return x;

        # LIGHT NAME                  
        - label:
            id: ${widget_name}_light_name_label
            y: -420
            x: 0
            height: 40
            width: 240
            long_mode: dot
            align: bottom_left
            text_font: nunito_18
            text_align: center
            text_color: misty_blue
            text: "Friendly name"

        # Home
        - label:
            id: ${widget_name}_home_button
            y: -5
            x: -5
            height: 80
            width: 80
            text_font: mdi_icons_40
            text_align: center
            text_color: white
            align: bottom_mid
            text: $mdi_home
            on_short_click:
                then:
                  lvgl.page.show: main_page           

        # LIGHT ARC
        - obj:
            id: ${widget_name}_light_bg_main_temperature
            hidden: false
            width: 240
            height: 480
            align: right_mid
            pad_all: 0
            bg_opa: transp
            clickable: false
            scrollable: false
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            widgets:
              - obj:
                  x: 240
                  width: 480
                  height: 480
                  scrollable: false
                  align: right_mid
                  pad_all: 0
                  bg_opa: transp
                  shadow_opa: transp
                  border_opa: transp
                  border_width: 0
                  widgets:
                    - obj:
                        width: 460
                        height: 460
                        align: center
                        clickable: true
                        radius: 260
                        bg_opa: transp
                        bg_color: slate_blue_gray
                        border_color: black
                        border_opa: 40%
                        border_width: 3

              - obj:
                  id: ${widget_name}_hue_gradient_obj
                  hidden: true
                  x: 222
                  width: 444
                  height: 444
                  radius: 222
                  align: right_mid
                  pad_all: 0
                  bg_grad: ${widget_name}_hue_gradient
                  bg_grad_dir: ver
                  shadow_opa: transp
                  border_opa: transp
                  border_width: 0
                  bg_opa: cover

              - obj:
                  id: ${widget_name}_color_temp_gradient_obj
                  x: 222
                  width: 444
                  height: 444
                  radius: 222
                  align: right_mid
                  pad_all: 0
                  bg_grad: ${widget_name}_color_temp_gradient
                  bg_grad_dir: ver
                  shadow_opa: transp
                  border_opa: transp
                  border_width: 0
                  bg_opa: cover

              - obj:
                  x: 188
                  width: 376
                  height: 376
                  align: right_mid
                  clickable: false
                  radius: 230
                  bg_color: slate_blue_gray
                  border_width: 0
                  border_opa: transp
                  bg_opa: cover

              - obj:
                  x: 183
                  width: 366
                  height: 366
                  align: right_mid
                  radius: 230
                  bg_color: slate_blue_gray
                  border_color: white
                  border_width: 3
                  border_opa: 15%

              # BACKGROUND ARC
              - obj:
                  x: 222
                  width: 444
                  height: 444
                  radius: 222
                  align: right_mid
                  pad_all: 0
                  bg_opa: transp
                  shadow_opa: transp
                  border_opa: transp
                  border_width: 0
                  widgets:
                    # ARC for HUE (hue)
                    - arc:
                        id: ${widget_name}_light_arc_hue
                        hidden: true
                        clickable: true
                        adjustable: true
                        adv_hittest: true
                        align: center
                        width: 444
                        height: 444
                        start_angle: 0
                        end_angle: 180
                        min_value: 0
                        max_value: 360
                        value: 265
                        arc_width: 34
                        rotation: 90.0
                        arc_opa: transp
                        indicator:
                          arc_opa: transp
                          arc_width: 34
                        knob:
                          pad_all: 0
                          bg_opa: transp
                          border_color: steel_blue
                          border_width: 4
                          shadow_opa: transp

                        # on_value to update the light color in real time
                        on_value:
                          - globals.set:
                              id: ${widget_name}_current_hue
                              value: !lambda return x;
                          - script.execute: ${widget_name}_update_lightbulb_color

                        on_release:
                          - homeassistant.action:
                              action: light.turn_on
                              data:
                                entity_id: "${light_entity}"
                              data_template:
                                hs_color: "{{ (hue|float, sat|float)|list }}"
                              variables:
                                hue: !lambda return x;
                                sat: !lambda return id(${widget_name}_current_saturation);

                    # ARC for COLOR TEMP (color temperature)
                    - arc:
                        id: ${widget_name}_light_arc_color_temp
                        hidden: false
                        clickable: true
                        adjustable: true
                        adv_hittest: true
                        align: center
                        width: 444
                        height: 444
                        start_angle: 0
                        end_angle: 180
                        min_value: 2000
                        max_value: 6500
                        value: 3000
                        arc_width: 34
                        rotation: 90.0
                        arc_opa: transp
                        indicator:
                          arc_opa: transp
                          arc_width: 34
                        knob:
                          pad_all: 0
                          bg_opa: transp
                          border_color: steel_blue
                          border_width: 4
                          shadow_opa: transp

                        # on_value to update the light color in real time
                        on_value:
                          - globals.set:
                              id: ${widget_name}_current_color_temp
                              value: !lambda return x;
                          - script.execute: ${widget_name}_update_lightbulb_color

                        on_release:
                          - homeassistant.action:
                              action: light.turn_on
                              data:
                                entity_id: "${light_entity}"
                                color_temp_kelvin: !lambda return int(x);

        # LIGHTBULB
        - obj:
            id: ${widget_name}_lightbulb_btn
            x: 0
            width: 160
            height: 160
            align: right_mid
            bg_opa: transp
            pad_all: 0
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            radius: 100
            widgets:
              # LIGHTBULB COLOR WIDGET - updates dynamically
              - obj:
                  id: ${widget_name}_lightbulb_color
                  clickable: false
                  x: 0
                  y: -30
                  width: 70
                  height: 70
                  radius: 35
                  align: center
                  bg_color: light_gray
                  bg_opa: cover
                  border_opa: transp
                  shadow_opa: transp
                  
              - image:
                  id: ${widget_name}_lightbulb_image
                  x: 0
                  y: 23
                  align: center
                  src: lightbulb_image


        # BACK
        - obj:
            id: ${widget_name}_light_back_btn 
            x: 150
            y: 0
            width: 80
            height: 70
            align: bottom_left
            bg_opa: transp
            pad_all: 0
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            radius: 0
            widgets:
              - obj:
                  y: -20
                  width: 80
                  height: 5
                  align: bottom_mid
                  bg_color: steel_blue
                  pad_all: 0
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  radius: 15
            # on_click:
              # - lvgl.widget.hide: light_select_widget
              # - delay: 100ms
              # - lvgl.page.show: home_page

script:
  # ═══════════════════════════════════════════════════════════════════════════
  # SCRIPT: Toggle between color_temp and hs modes
  # ═══════════════════════════════════════════════════════════════════════════
  - id: ${widget_name}_toggle_gradient
    then:
      - if:
          condition:
            lambda: return id(${widget_name}_is_temp_mode);
          then:
            # ─────────────────────────────────────────────────────────────────
            # COLOR_TEMP MODE
            # ─────────────────────────────────────────────────────────────────
            - lvgl.widget.hide: ${widget_name}_hue_gradient_obj
            - lvgl.widget.hide: ${widget_name}_light_arc_hue
            - lvgl.widget.show: ${widget_name}_color_temp_gradient_obj
            - lvgl.widget.show: ${widget_name}_light_arc_color_temp
            - lvgl.widget.hide: ${widget_name}_light_saturation_background
            - lvgl.obj.update:
                id: ${widget_name}_light_brightness_background
                x: -110

          else:
            # ─────────────────────────────────────────────────────────────────
            # HUE/SATURATION MODE
            # ─────────────────────────────────────────────────────────────────
            - lvgl.widget.hide: ${widget_name}_color_temp_gradient_obj
            - lvgl.widget.hide: ${widget_name}_light_arc_color_temp
            - lvgl.widget.show: ${widget_name}_hue_gradient_obj
            - lvgl.widget.show: ${widget_name}_light_arc_hue
            - if:
                condition:
                  lambda: 'return id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb);'
                then:
                  - lvgl.widget.show: ${widget_name}_light_saturation_background
                  - lvgl.obj.update:
                      id: ${widget_name}_light_brightness_background
                      x: -160

  # ═══════════════════════════════════════════════════════════════════════════
  # SCRIPT: Update the lightbulb widget color
  # ═══════════════════════════════════════════════════════════════════════════
  - id: ${widget_name}_update_lightbulb_color
    then:
      - lambda: |-
          int r = 255, g = 255, b = 255;
          
          // ═══════════════════════════════════════════════════════════════════
          // CHECK: Does the light support color modes?
          // ═══════════════════════════════════════════════════════════════════
          bool has_color_modes = id(${widget_name}_supports_hs) || 
                                 id(${widget_name}_supports_rgb) || 
                                 id(${widget_name}_supports_color_temp);
          
          // ═══════════════════════════════════════════════════════════════════
          // CHECK: Is the light turned on?
          // ═══════════════════════════════════════════════════════════════════
          bool is_light_on = id(${widget_name}_light_state).state;
          
          if (!is_light_on) {
            // ═════════════════════════════════════════════════════════════════
            // LIGHT IS OFF -> GREY COLOR (regardless of mode)
            // ═════════════════════════════════════════════════════════════════
            r = 153;  // 60% от 255
            g = 153;
            b = 153;
            
          } else if (has_color_modes) {
            // ═════════════════════════════════════════════════════════════════
            // MODE 1: LIGHT ON + COLOR SUPPORTED (HS/RGB/ColorTemp)
            // ═════════════════════════════════════════════════════════════════
            
            if (id(${widget_name}_is_temp_mode)) {
              // ───────────────────────────────────────────────────────────────
              // SUBMODE: COLOR TEMPERATURE (Color Temp)
              // Convert Kelvin → RGB
              // ───────────────────────────────────────────────────────────────
              float temp = id(${widget_name}_current_color_temp) / 100.0;
              
              // Algorithm to convert color temperature to RGB
              // Source: Tanner Helland algorithm
              
              // Red channel
              if (temp <= 66) {
                r = 255;
              } else {
                r = temp - 60;
                r = 329.698727446 * pow(r, -0.1332047592);
                r = (r < 0) ? 0 : ((r > 255) ? 255 : r);
              }
              
              // Green channel
              if (temp <= 66) {
                g = temp;
                g = 99.4708025861 * log(g) - 161.1195681661;
              } else {
                g = temp - 60;
                g = 288.1221695283 * pow(g, -0.0755148492);
              }
              g = (g < 0) ? 0 : ((g > 255) ? 255 : g);
              
              // Blue channel
              if (temp >= 66) {
                b = 255;
              } else if (temp <= 19) {
                b = 0;
              } else {
                b = temp - 10;
                b = 138.5177312231 * log(b) - 305.0447927307;
                b = (b < 0) ? 0 : ((b > 255) ? 255 : b);
              }            
              
            } else {
              // ───────────────────────────────────────────────────────────────
              // SUBMODE: HUE/SATURATION (HS)
              // Convert HSV → RGB
              // ───────────────────────────────────────────────────────────────
              float h = id(${widget_name}_current_hue);
              float s = id(${widget_name}_current_saturation) / 100.0;
              float v = 1.0; // Use full brightness to display the color
              
              float c = v * s;
              float x = c * (1 - fabs(fmod(h / 60.0, 2) - 1));
              float m = v - c;
              
              float r_prime, g_prime, b_prime;
              
              if (h >= 0 && h < 60) {
                r_prime = c; g_prime = x; b_prime = 0;
              } else if (h >= 60 && h < 120) {
                r_prime = x; g_prime = c; b_prime = 0;
              } else if (h >= 120 && h < 180) {
                r_prime = 0; g_prime = c; b_prime = x;
              } else if (h >= 180 && h < 240) {
                r_prime = 0; g_prime = x; b_prime = c;
              } else if (h >= 240 && h < 300) {
                r_prime = x; g_prime = 0; b_prime = c;
              } else {
                r_prime = c; g_prime = 0; b_prime = x;
              }
              
              r = (r_prime + m) * 255;
              g = (g_prime + m) * 255;
              b = (b_prime + m) * 255;
              
            }
            
            // ─────────────────────────────────────────────────────────────────
            // Apply brightness scaling: 60% → 100%
            // ─────────────────────────────────────────────────────────────────
            float real_brightness = id(${widget_name}_current_brightness) / 255.0;
            float brightness_display = 0.6 + (real_brightness * 0.4);
            
            r = r * brightness_display;
            g = g * brightness_display;
            b = b * brightness_display;     
            
          } else {
            // ═════════════════════════════════════════════════════════════════
            // MODE 2: LIGHT ON + NO COLOR (brightness/onoff)
            // ═════════════════════════════════════════════════════════════════
            
            // ───────────────────────────────────────────────────────────────
            // LIGHT IS ON -> YELLOW COLOR (0xFFFF00)
            // ───────────────────────────────────────────────────────────────
            r = 255;
            g = 255;
            b = 0;
            
            // If brightness is supported - apply scaling
            if (id(${widget_name}_supports_brightness)) {
              float real_brightness = id(${widget_name}_current_brightness) / 255.0;
              float brightness_display = 0.6 + (real_brightness * 0.4);
              
              r = r * brightness_display;
              g = g * brightness_display;
              b = b * brightness_display;
              
            } else {
              // No brightness support - use yellow at 80%
              r = 204; // 80% of 255
              g = 204;
              b = 0;
              
            }
          }
          
          // ═══════════════════════════════════════════════════════════════════
          // APPLYING COLOR TO THE WIDGET
          // ═══════════════════════════════════════════════════════════════════
          
          // Form the color as 0xRRGGBB
          uint32_t color = (r << 16) | (g << 8) | b;
          
          // Store in global for thread-safe update
          id(${widget_name}_calc_color) = color;

      - lvgl.obj.update:
          id: ${widget_name}_lightbulb_color
          bg_color: !lambda return lv_color_hex(id(${widget_name}_calc_color));


  # ═══════════════════════════════════════════════════════════════════════════
  # SCRIPT: Update widget visibility
  # ═══════════════════════════════════════════════════════════════════════════
  - id: ${widget_name}_update_widget_visibility
    then:
      # ═════════════════════════════════════════════════════════════════════
      # CONTROL VISIBILITY OF ARCS AND BULB BUTTON POSITION
      # ═════════════════════════════════════════════════════════════════════
      - lambda: |-
          // Check for the presence of "arched" modes (HS or ColorTemp)
          bool has_arc_modes = id(${widget_name}_supports_hs) || 
                               id(${widget_name}_supports_rgb) || 
                               id(${widget_name}_supports_color_temp);
                          
      - if:
          condition:
            lambda: |-
              return id(${widget_name}_supports_hs) || 
                     id(${widget_name}_supports_rgb) || 
                     id(${widget_name}_supports_color_temp);
          then:
            # ─────────────────────────────────────────────────────────────────
            # ARCHED MODES ARE AVAILABLE → Show arcs, place button on the right
            # ─────────────────────────────────────────────────────────────────
            - lvgl.widget.show: ${widget_name}_light_bg_main_temperature

            - lvgl.obj.update:
                id: ${widget_name}_lightbulb_btn
                align: right_mid
                x: 0
                y: 0

            - lvgl.obj.update:
                id: ${widget_name}_light_back_btn
                align: bottom_left
                x: 150

            # Label in arched-mode
            - lvgl.obj.update:
                id: ${widget_name}_light_name_label
                align: bottom_left
                x: 20

          else:
            # ─────────────────────────────────────────────────────────────────
            # NO ARCHED MODES → Hide arcs, reposition buttons
            # ─────────────────────────────────────────────────────────────────
            - lvgl.widget.hide: ${widget_name}_light_bg_main_temperature

            # Label in NO-arc mode
            - lvgl.obj.update:
                id: ${widget_name}_light_name_label
                align: bottom_mid
                x: 0

            # Check: ON/OFF mode (button centered) or BRIGHTNESS mode (button higher)
            - if:
                condition:
                  lambda: 'return !id(${widget_name}_supports_brightness);'
                then:
                  # ═══════════════════════════════════════════════════════════
                  # ON/OFF MODE → Lightbulb button centered
                  # ═══════════════════════════════════════════════════════════
                  - lvgl.obj.update:
                      id: ${widget_name}_lightbulb_btn
                      align: center
                      x: 0
                      y: -40
                else:
                  # ═══════════════════════════════════════════════════════════
                  # BRIGHTNESS MODE WITHOUT ARCS → Lightbulb button above center
                  # ═══════════════════════════════════════════════════════════
                  - lvgl.obj.update:
                      id: ${widget_name}_lightbulb_btn
                      align: center
                      x: 0
                      y: -40

            # BACK button is always centered at the bottom in no-arc modes
            - lvgl.obj.update:
                id: ${widget_name}_light_back_btn
                align: bottom_mid
                x: 0

  # ─────────────────────────────────────────────────────────────────────
  # CONTROL VISIBILITY OF BRIGHTNESS SLIDER
  # ─────────────────────────────────────────────────────────────────────
      - if:
          condition:
            lambda: 'return id(${widget_name}_supports_brightness);'
          then:
            - lvgl.widget.show: ${widget_name}_light_brightness_background
            
            # Check mode (with arcs or without)
            - if:
                condition:
                  lambda: |-
                    return id(${widget_name}_supports_hs) || 
                           id(${widget_name}_supports_rgb) || 
                           id(${widget_name}_supports_color_temp);
                then:
                  # ═══════════════════════════════════════════════════════════
                  # MODE WITH ARCS → Vertical slider on left
                  # ═══════════════════════════════════════════════════════════
                  - if:
                      condition:
                        lambda: |-
                          return !id(${widget_name}_is_temp_mode) && 
                                 (id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb));
                      then:
                        # Saturation visible → brightness at -160
                        - lvgl.obj.update:
                            id: ${widget_name}_light_brightness_background
                            x: -160
                            y: 0
                            radius: 20
                            width: 80
                            height: 260
                        - lvgl.slider.update:
                            id: ${widget_name}_light_brightness_slider
                            width: 60
                            height: 240
                      else:
                        # Saturation hidden → brightness at -110
                        - lvgl.obj.update:
                            id: ${widget_name}_light_brightness_background
                            x: -110
                            y: 0
                            radius: 20
                            width: 80
                            height: 260
                        - lvgl.slider.update:
                            id: ${widget_name}_light_brightness_slider
                            width: 60
                            height: 240
                else:
                  # ═══════════════════════════════════════════════════════════
                  # MODE WITHOUT ARCS → Horizontal slider centered
                  # ═══════════════════════════════════════════════════════════
                  - lvgl.obj.update:
                      id: ${widget_name}_light_brightness_background
                      x: 0
                      y: 100
                      radius: 20
                      width: 260
                      height: 80
                  - lvgl.slider.update:
                      id: ${widget_name}_light_brightness_slider
                      width: 240
                      height: 60

          else:
            - lvgl.widget.hide: ${widget_name}_light_brightness_background
      
  # ─────────────────────────────────────────────────────────────────────
  # CONTROL VISIBILITY OF SATURATION SLIDER
  # ─────────────────────────────────────────────────────────────────────
      - if:
          condition:
            lambda: 'return id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb);'
          then:
            # If in HS mode - show, if in temp mode - hide
            - if:
                condition:
                  lambda: 'return !id(${widget_name}_is_temp_mode);'
                then:
                  - lvgl.widget.show: ${widget_name}_light_saturation_background
                  # Brightness at original position
                  - lvgl.obj.update:
                      id: ${widget_name}_light_brightness_background
                      x: -160

                else:
                  - lvgl.widget.hide: ${widget_name}_light_saturation_background
                  # Brightness shifted right
                  - lvgl.obj.update:
                      id: ${widget_name}_light_brightness_background
                      x: -110

          else:
            - lvgl.widget.hide: ${widget_name}_light_saturation_background
      
  # ─────────────────────────────────────────────────────────────────────
  # CONTROL VISIBILITY OF HS ARC AND GRADIENT
  # ─────────────────────────────────────────────────────────────────────
      - if:
          condition:
            lambda: 'return id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb);'
          then:
            # HS supported - show arc and gradient in HS mode
            - if:
                condition:
                  lambda: 'return !id(${widget_name}_is_temp_mode);'
                then:
                  - lvgl.widget.show: ${widget_name}_hue_gradient_obj
                  - lvgl.widget.show: ${widget_name}_light_arc_hue

                else:
                  - lvgl.widget.hide: ${widget_name}_hue_gradient_obj
                  - lvgl.widget.hide: ${widget_name}_light_arc_hue

          else:
            # HS not supported - always hide
            - lvgl.widget.hide: ${widget_name}_hue_gradient_obj
            - lvgl.widget.hide: ${widget_name}_light_arc_hue
      
  # ─────────────────────────────────────────────────────────────────────
  # CONTROL VISIBILITY OF COLOR TEMP ARC AND GRADIENT
  # ─────────────────────────────────────────────────────────────────────
      - if:
          condition:
            lambda: 'return id(${widget_name}_supports_color_temp);'
          then:
            # Color Temp supported - show arc and gradient in temp mode
            - if:
                condition:
                  lambda: 'return id(${widget_name}_is_temp_mode);'
                then:
                  - lvgl.widget.show: ${widget_name}_color_temp_gradient_obj
                  - lvgl.widget.show: ${widget_name}_light_arc_color_temp

                else:
                  - lvgl.widget.hide: ${widget_name}_color_temp_gradient_obj
                  - lvgl.widget.hide: ${widget_name}_light_arc_color_temp

          else:
            # Color Temp not supported - always hide
            - lvgl.widget.hide: ${widget_name}_color_temp_gradient_obj
            - lvgl.widget.hide: ${widget_name}_light_arc_color_temp
      
  # ─────────────────────────────────────────────────────────────────────
  # AUTOMATIC MODE SELECTION (if the bulb supports only one)
  # ─────────────────────────────────────────────────────────────────────
      - if:
          condition:
            lambda: |-
              // If the bulb DOES NOT support both modes - choose the available one
              return !(id(${widget_name}_supports_color_temp) && 
                      (id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb)));
          then:
            
            # Automatic mode selection
            - if:
                condition:
                  lambda: 'return id(${widget_name}_supports_hs) || id(${widget_name}_supports_rgb);'
                then:
                  # If only color is supported - switch to HS mode
                  - lambda: |-
                      id(${widget_name}_is_temp_mode) = false;
                  - script.execute: ${widget_name}_toggle_gradient
                else:
                  - if:
                      condition:
                        lambda: 'return id(${widget_name}_supports_color_temp);'
                      then:
                        # If only temperature is supported - switch to temp mode
                        - lambda: |-
                            id(${widget_name}_is_temp_mode) = true;
                        - script.execute: ${widget_name}_toggle_gradient
